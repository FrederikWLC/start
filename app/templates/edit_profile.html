{% extends "base.html" %}
{% block body %}
  
          
<div class="container has-text-centered" id="container">
  
  <div valign="top" id="bigBox" class="row">
  
    <div id="leftBox" class="column">
      <a href="javascript:location.replace('/profile/')" class="button is-primary is-normal is-rounded is-inverted" id="cancel-button">
      <span class="icon is-normal is-danger">
      <i class="fa fa-times fa-2x"></i>
      </span>
      </a>
    </div>

    <div id="middleBox" class="column">
      <h1 class="title" id="header">Edit Profile</h1>
    </div>
    
    <div id="rightBox" class="column">
      <button class="button is-primary is-normal is-rounded" id="save-button">
      <span>Save</span>
      </button>
    </div>

  </div>

  <hr>

  <div id="profile_pic">
      <div id="image-wrapper" class="back-element">
      <img id="image" src="{{ current_user.get_profile_pic(256) }}">
      </div>
      <input type="file"  accept="image/*" name="image" id="upload" onchange="loadFile(event)" style="display: none;">
      <button class="button is-success is-large is-inverted front-element" id="upload-button">
    <span class="icon is-medium">
      <i id="upload-icon" class="fa fa-camera-retro"></i>
    </span>
  </button>
  </div>
  <br>
  <div>
      <h1><b>Name</b></h1>
      <textarea class="textarea has-fixed-size" placeholder="Add your name" id="name-field" rows="1">{{current_user.name}}</textarea> 
      <br>
      <h1><b>Bio</b></h1>
      <textarea class="textarea has-fixed-size" placeholder="Add your bio" id="bio-field" rows="3">{% if current_user.bio %}{{ current_user.bio }}{% endif %}</textarea>
      <br>
      <h1><b>Location</b></h1>
      <textarea class="textarea has-fixed-size" placeholder="Add your location" id="location-field" rows="2">{{ current_user.location }}</textarea>
      <br>
      <h1><b>Birthday</b></h1>
      <div>
      <div  class='select'> 
        <select id="month"> 
          <option value='' disabled hidden selected>Month</option> 
          <option value='1' {% if current_user.birthday.month == 1 %} selected {% endif %}>January</option>
          <option value='2' {% if current_user.birthday.month == 2 %} selected {% endif %}>February</option> 
          <option value='3' {% if current_user.birthday.month == 3 %} selected {% endif %}>March</option> 
          <option value='4' {% if current_user.birthday.month == 4 %} selected {% endif %}>April</option> 
          <option value='5' {% if current_user.birthday.month == 5 %} selected {% endif %}>May</option> 
          <option value='6' {% if current_user.birthday.month == 6 %} selected {% endif %}>June</option> 
          <option value='7' {% if current_user.birthday.month == 7 %} selected {% endif %}>July</option> 
          <option value='8' {% if current_user.birthday.month == 8 %} selected {% endif %}>August</option> 
          <option value='9' {% if current_user.birthday.month == 9 %} selected {% endif %}>September</option> 
          <option value='10' {% if current_user.birthday.month == 10 %} selected {% endif %}>October</option> 
          <option value='11' {% if current_user.birthday.month == 11 %} selected {% endif %}>November</option> 
          <option value='12' {% if current_user.birthday.month == 12 %} selected {% endif %}>December</option> 
        </select>
      </div>
      <div  class='select'> 
        <select id="day"> 
          <option value='' disabled hidden selected>Day</option> 
          {% for i in range(1,32) %}
          <option value='{{i}}' {% if current_user.birthday.day == i %} selected {% endif %}>{{i}}</option> 
          {% endfor %}
        </select>
      </div>
      <div  class='select'> 
        <select id="year"> 
          <option value='' disabled hidden selected>Year</option> 
          {% for i in range(2020,1899,-1) %}
          <option value='{{i}}' {% if i % 4 == 0 and (i % 100 != 0 or i % 400 == 0) %} data-leapyear="1" {% else %} data-leapyear="0" {% endif %} {% if current_user.birthday.year == i %} selected {% endif %}>{{i}}</option> 
          {% endfor %}
        </select>
      </div>
      <div>
      <br>

      <h1><b>Gender</b></h1>
      <div>
      <div class='select'> 
        <select id="gender"> 
          <option selected>Unknown</option>
          <option {% if current_user.gender == "Male" %} selected {% endif %}>Male</option>
          <option {% if current_user.gender == "Female" %} selected {% endif %}>Female</option>
          <option {% if current_user.gender == "Other" %} selected {% endif %}>Other</option>
      </select>
    </div>
  </div>
      <br>
      <h1><b>Skills</b></h1>
      <div id="skills">
      {% for skill in current_user.skills %}
        <div class='skill'>
          <button class='button is-info is-normal is-'>
            <span>{{ skill.title }}</span>
            <span class='icon remove-skill'><a class="delete"></a></span></button>
        </div>
      {% endfor %}
      </div>

        <div id='select-skill' class='select is-info vanish'> 
        <select id="selected-skill"> 
          <option value='' disabled hidden selected>Select skill</option> 
          {% for title in available_skills %}
          {% if not current_user.has_skill(title) %}
          <option>{{ title }}</option>
          {% endif %}
          {% endfor %}
        </select>
      </div>
        <button id='add-skill' class='button is-info is-normal is-inverted vanish' disabled><span>Add</span><span class='icon is-normal is-danger'><i class='fa fa-plus'></i></span></button>
      <button id="add-a-skill" class="button is-info is-normal is-inverted {% if current_user.has_skills(available_skills) %} vanish {% endif %}">
      <span>Add skill</span>
      <span class="icon is-normal is-danger"><i class="fa fa-plus"></i>
      </span></button>
  </div>

  <br>

  <div id="feedback">
  </div>

</div>
{% endblock %}
{% block scripts %}
<style>


#container {
  width: 500px;
  height: 0px;
  margin-bottom: 0;
}

#datop:after {
  display: table;
  clear: both;
  width:100%;
}

#cancel-button {
  margin: 10px;
  border-radius: 0px;
}


#header {
  margin: 5px;
  float: middle;
 font-size: 24px;
}


#save-button {
  float: right;
}

#profile_pic {
 position: relative;
 margin: 0 auto;
 width: 256px;
 height: 256px;
}

#image {
  width: 100%;
 height: 100%;
  filter: brightness(75%);
}

.back-element {
  width: 100%;
  height: 100%;
  position: relative;
  z-index: 1;
}

.front-element {
  position: absolute !important;
  top: 50% !important;
  right: 28.5% !important;
  z-index: 2 !important;
  transform: translate(-50%, -50%);
}

#upload-icon {
  color: rgb(232,232,232);
}

#upload-button {
  border-radius: 100%;
  background: rgba(0,0,0,0) !important;
}

#upload-button:hover {
  background: rgba(255,255,255,.125) !important;
}

.column {
  margin-top: 10px;
  margin-bottom: 10px;
  vertical-align: middle;
  float: left;
  padding: 10px;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

#bigBox {
  width:100%;
  height: 50px;
}

#leftBox {
  height: 100%;
  float:left;
  width: 20%;
  padding: 0px;
  padding-right: 10px;
}
#middleBox {
  height: 100%;
  float:middle;
  width: 30%;
}

#rightBox {
  height: 100%;
  float:right;
  width: 50%;
}

.vanish {
  display: none;
}

select option[disabled] {
    display: none;
}


.skill {
  margin-left: 5px;
  margin-right: 5px;
  margin-bottom: 5px;
  margin-top: 5px;
  display: inline-block;
}
</style>
<script src="/static/js/navbar.js"></script>
<script>
  function message(status, shake=false, id="") {
  if (shake) {
    $("#"+id).effect("shake", {direction: "right", times: 2, distance: 8}, 250);
  } 
  document.getElementById("feedback").innerHTML = status;
  $("#feedback").show().delay(2000).fadeOut();
}

 $(document).on("click", "#save-button", function() {
   console.log("Applying edit");
   var skills = $("#skills :button").map(function() { return $(this).children().first().text();}).get();
   
   var formData = new FormData();
   formData.append('image', $("#upload").prop('files')[0]);

   formData.append("name", $("#name-field").val());

   formData.append("bio", $("#bio-field").val());

   formData.append("location", $("#location-field").val());

   if ($("#month").val() === null) {
    formData.append("month", '');
   } else {
    formData.append("month", $("#month").val());
  }
   
   if ($("#day").val() === null) {
    formData.append("day", '');
   } else {
    formData.append("day", $("#day").val());
  }

  if ($("#year").val() === null) {
    formData.append("year", '');
   } else {
    formData.append("year", $("#year").val());
  }

   formData.append("gender", $("#gender").val());

   formData.append("skills", JSON.stringify(skills));

    $.post({
      type: "POST",
      url: "/settings/profile/",
      data: formData,
      processData: false,
      contentType: false,
      success(response) {
        var status = JSON.parse(response)["status"];
        if (status === "Successfully saved") { location.replace("/profile/"); }
        else{message(status, true, "feedback");}
        
      }});
  });


$(document).on('change','#selected-skill',function(){
               if ($('#selected-skill').val() != 'Select skill') {
                $('#add-skill').prop("disabled", false);
               }       
             });

$(document).on('change', '#month', function() {
  console.log("Change in month");
  if ($('#month').val() == 1 || $('#month').val() == 3 || $('#month').val() == 5 || $('#month').val() == 7 || $('#month').val() == 8 || $('#month').val() == 10 || $('#month').val() == 12) {
    $('#day').children().eq(29).prop('disabled', false);
    $('#day').children().eq(30).prop('disabled', false);
    $('#day').children().eq(31).prop('disabled', false);
  }
  else if ($('#month').val() == 4 || $('#month').val() == 6 || $('#month').val() == 9 || $('#month').val() == 11) {
    $('#day').children().eq(29).prop('disabled', false);
    $('#day').children().eq(30).prop('disabled', false);
    $('#day').children().eq(31).prop('disabled', true);
    $('#year').children().prop('disabled', false);

    if ($('#day option:selected').val() == 31) {
      $('#day option:selected').prop("selected", false);
    }
  }
  else if ($('#month').val() == 2) {
    console.log("February")
    // If Leap Year; add the 29th day of February
    if ($('#year option:selected').attr('data-leapyear') == 1 ){
      $('#day').children().eq(29).prop('disabled', false);
    }
    else {
      $('#day').children().eq(29).prop('disabled', true);
    }
    $('#day').children().eq(30).prop('disabled', true);
    $('#day').children().eq(31).prop('disabled', true);

    if ($('#day option:selected').val() >= 30) {
      $('#day option:selected').prop("selected", false);
    }

    if ($('#day option:selected').val() == 29) {

      if ($('#year option:selected').attr('data-leapyear') == 0) {
        console.log("Not leapyear");
        $('#day option:selected').prop("selected", false);
      }
      else {
      $('#year').children('[data-leapyear="0"]').prop('disabled', true);
    }
    }
  }
});

$(document).on('change', '#day', function() {
  if ($('#day').val() == 29 && $('#month').val() == 2) {
    $('#year').children('[data-leapyear="0"]').prop('disabled', true);
  }
  else {
    $('#year').children().prop('disabled', false);
  }});

$(document).on('change', '#year', function() {
  // If Leap Year; add the 29th day of February
  if (parseInt($('#year').val()) % 4 === 0 && (parseInt($('#year').val()) % 100 !== 0 || parseInt($('#year').val()) % 400 === 0)) {
    $('#day').children().eq(29).prop('disabled', false);;
  }});

 $(document).on("click", "#add-a-skill", function() {
    $('#add-a-skill').addClass("vanish");
    $('#select-skill').removeClass("vanish");
    if ($('#selected-skill').val() == 'Select skill') {
            $('#add-skill').prop("disabled", true);
    }       
    $('#add-skill').removeClass("vanish");
  });

 $(document).on("click", "#add-skill", function() {
  $('#select-skill').addClass("vanish");
  $('#add-skill').addClass("vanish");
  $('#add-a-skill').removeClass("vanish");
  $("#skills").append("<div class='skill'><button class='button is-info is-normal is-'><span class='skill-title'>"+$('#selected-skill').val()+"</span><span class='icon remove-skill'><a class='delete'></a></span></button></div>");
  $('#selected-skill option:selected').remove();
  console.log($('#selected-skill').children().length)
  if ($('#selected-skill').children().length == 1) {
    $('#add-a-skill').addClass("vanish");
  }
 });


 $(document).on("click", ".remove-skill", function() {
  $('#selected-skill').append('<option>'+$(this).prev('span').text()+'</option>')
  $(this).closest('div').remove();
  $('#add-a-skill').removeClass("vanish");

});


function loadFile(input) {
  if (event.target.files[0]) {
  $("#image").attr('src', URL.createObjectURL(event.target.files[0]));
}
  console.log("WOOOOOW");
};

$(document).on("click", "#upload-button", function() {
  $("#upload").click();
});

</script>
{% endblock %}